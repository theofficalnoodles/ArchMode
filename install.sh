#!/bin/bash

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -eq 0 ]]; then
   echo -e "${RED}Don't run this script as root. Use sudo when needed.${NC}"
   exit 1
fi

# Fancy header
clear
echo -e "${CYAN}${BOLD}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     ArchMode Installation Script       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
echo ""

# Check if this is an update
if [ -f "/usr/local/bin/archmode" ]; then
    echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${YELLOW}â•‘     Existing Installation Detected     â•‘${NC}"
    echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}This will update your existing ArchMode installation.${NC}"
    echo -e "${CYAN}Your configuration and logs will be preserved.${NC}"
    echo ""
    read -p "Continue with update? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Update cancelled.${NC}"
        exit 1
    fi
    UPDATING=true
else
    UPDATING=false
fi

# Check if archmode.sh exists
if [ ! -f "archmode.sh" ]; then
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘           ERROR DETECTED!              â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${RED}âœ— archmode.sh not found!${NC}"
    echo -e "${YELLOW}âœ Make sure you're running this script from the ArchMode directory.${NC}"
    echo -e "${YELLOW}âœ Current directory: ${BLUE}$(pwd)${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ“ Found archmode.sh${NC}"
echo ""

# Make archmode.sh executable
echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${CYAN}â”‚  ${BOLD}Step 1: Setting permissions${NC}${CYAN}           â”‚${NC}"
echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
chmod +x archmode.sh
echo -e "${GREEN}âœ“ Made archmode.sh executable${NC}"
echo ""

# Install the script
echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
if [ "$UPDATING" = true ]; then
    echo -e "${CYAN}â”‚  ${BOLD}Step 2: Updating system installation${NC}${CYAN}  â”‚${NC}"
else
    echo -e "${CYAN}â”‚  ${BOLD}Step 2: Installing to system${NC}${CYAN}          â”‚${NC}"
fi
echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
sudo cp archmode.sh /usr/local/bin/archmode
sudo chmod +x /usr/local/bin/archmode
if [ "$UPDATING" = true ]; then
    echo -e "${GREEN}âœ“ Updated /usr/local/bin/archmode${NC}"
else
    echo -e "${GREEN}âœ“ Installed to /usr/local/bin/archmode${NC}"
fi
echo ""

# Create config directory
echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${CYAN}â”‚  ${BOLD}Step 3: Creating directories${NC}${CYAN}          â”‚${NC}"
echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
mkdir -p ~/.config/archmode
mkdir -p ~/.local/share/archmode
echo -e "${GREEN}âœ“ Created ~/.config/archmode${NC}"
echo -e "${GREEN}âœ“ Created ~/.local/share/archmode${NC}"
echo ""

# Install systemd service if it exists
if [ -f "archmode.service" ]; then
    echo -e "${CYAN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    if [ "$UPDATING" = true ]; then
        echo -e "${CYAN}â”‚  ${BOLD}Step 4: Updating systemd service${NC}${CYAN}      â”‚${NC}"
    else
        echo -e "${CYAN}â”‚  ${BOLD}Step 4: Installing systemd service${NC}${CYAN}    â”‚${NC}"
    fi
    echo -e "${CYAN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    sudo cp archmode.service /etc/systemd/system/
    sudo systemctl daemon-reload
    if [ "$UPDATING" = true ]; then
        echo -e "${GREEN}âœ“ Systemd service updated${NC}"
    else
        echo -e "${GREEN}âœ“ Systemd service installed${NC}"
    fi
    echo ""
fi

# Success message
echo ""
if [ "$UPDATING" = true ]; then
    echo -e "${GREEN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘       Update Complete! ğŸ‰              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
    echo -e "${CYAN}âœ Your ArchMode has been updated successfully!${NC}"
else
    echo -e "${GREEN}${BOLD}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘     Installation Complete! ğŸ‰          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo ""
    echo -e "${CYAN}âœ Run:${NC} ${BOLD}archmode${NC} ${CYAN}to start${NC}"
    echo -e "${CYAN}âœ Run:${NC} ${BOLD}archmode help${NC} ${CYAN}for usage info${NC}"
fi
echo ""
echo -e "${YELLOW}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
echo -e "${YELLOW}â”‚  Enjoy tweaking your Arch Linux! ğŸš€   â”‚${NC}"
echo -e "${YELLOW}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
echo ""
